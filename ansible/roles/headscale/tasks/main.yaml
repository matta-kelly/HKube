# ==============================================================================
# Headscale Role - Install and Configure
# ==============================================================================

- name: Download Headscale
  ansible.builtin.get_url:
    url: "https://github.com/juanfont/headscale/releases/download/v{{ headscale_version }}/headscale_{{ headscale_version }}_linux_amd64.deb"
    dest: "/tmp/headscale.deb"
    mode: "0644"

- name: Install Headscale
  ansible.builtin.apt:
    deb: /tmp/headscale.deb

- name: Create Headscale config directory
  ansible.builtin.file:
    path: /etc/headscale
    state: directory
    mode: "0755"

- name: Configure Headscale
  ansible.builtin.template:
    src: config.yaml.j2
    dest: /etc/headscale/config.yaml
    owner: headscale
    group: headscale
    mode: "0600"
  notify: Restart Headscale

- name: Write OIDC client secret
  ansible.builtin.copy:
    content: "{{ oidc_client_secret }}"
    dest: /etc/headscale/oidc_client_secret
    owner: headscale
    group: headscale
    mode: "0600"
  when: oidc_enabled | default(false)
  notify: Restart Headscale

- name: Deploy ACL policy
  ansible.builtin.template:
    src: acl.yaml.j2
    dest: /etc/headscale/acl.yaml
    owner: headscale
    group: headscale
    mode: "0600"
  notify: Restart Headscale

- name: Enable and start Headscale
  ansible.builtin.systemd:
    name: headscale
    enabled: true
    state: started

- name: Wait for Headscale to start
  ansible.builtin.wait_for:
    port: 443
    delay: 5
    timeout: 60

# ------------------------------------------------------------------------------
# Create user and generate authkey
# ------------------------------------------------------------------------------

- name: Check if h-kube user exists
  ansible.builtin.command: headscale users list -o json
  register: headscale_users
  changed_when: false

- name: Create h-kube user
  ansible.builtin.command: headscale users create h-kube
  when: "'h-kube' not in headscale_users.stdout"

- name: Check for existing authkey
  ansible.builtin.stat:
    path: /etc/headscale/authkey
  register: authkey_file

- name: Generate authkey
  ansible.builtin.shell: |
    headscale preauthkeys create --user h-kube --reusable --expiration 87600h
  register: authkey_output
  when: not authkey_file.stat.exists

- name: Save authkey to server
  ansible.builtin.copy:
    content: "{{ authkey_output.stdout }}"
    dest: /etc/headscale/authkey
    owner: headscale
    group: headscale
    mode: "0600"
  when: authkey_output.changed

- name: Read authkey
  ansible.builtin.slurp:
    src: /etc/headscale/authkey
  register: authkey_content

# Set a fact so tailscale role can use it
- name: Set authkey fact for tailscale role
  ansible.builtin.set_fact:
    headscale_authkey: "{{ authkey_content.content | b64decode | trim }}"

- name: Display authkey
  ansible.builtin.debug:
    msg: |
      
      =============================================
      SAVE THIS TO YOUR PASSWORD MANAGER AND .env:
      
      HEADSCALE_AUTHKEY="{{ authkey_content.content | b64decode | trim }}"
      =============================================