# Headscale configuration
# NOTE: Headscale runs behind Caddy reverse proxy.
# Caddy handles TLS termination on :443, proxies to Headscale on :8080.
server_url: https://{{ headscale_domain }}
listen_addr: {{ headscale_listen_addr | default('127.0.0.1:8080') }}
metrics_listen_addr: 127.0.0.1:9090

grpc_listen_addr: 127.0.0.1:50443
grpc_allow_insecure: false

private_key_path: /var/lib/headscale/private.key
noise:
  private_key_path: /var/lib/headscale/noise_private.key

prefixes:
  v4: 100.64.0.0/10
  v6: fd7a:115c:a1e0::/48

derp:
  server:
    enabled: true
    region_id: 999
    region_code: "hs"
    region_name: "Headscale Embedded"
    stun_listen_addr: 0.0.0.0:3478
    private_key_path: /var/lib/headscale/derp_server_private.key
  urls: []
  auto_update_enabled: true
  update_frequency: 24h

disable_check_updates: false
ephemeral_node_inactivity_timeout: 30m

database:
  type: sqlite
  sqlite:
    path: /var/lib/headscale/db.sqlite

log:
  format: text
  level: info

dns:
  magic_dns: true
  base_domain: {{ mesh_domain }}
  nameservers:
    global:
      - 1.1.1.1
      - 9.9.9.9

# TLS is handled by Caddy reverse proxy - disable Headscale's built-in TLS
tls_cert_path: ""
tls_key_path: ""
# tls_letsencrypt_* settings removed - Caddy handles HTTPS

{% if oidc_enabled | default(false) %}
# OIDC Authentication via Authentik
oidc:
  only_start_if_oidc_is_available: true
  issuer: "https://auth.{{ kube_domain }}/application/o/headscale/"
  client_id: "{{ oidc_client_id }}"
  client_secret_path: /etc/headscale/oidc_client_secret
  scope: ["openid", "profile", "email", "groups"]

  # Only allow users in these Authentik groups to login
  # Note: Groups scope may not exist in Authentik yet - that's OK
  allowed_groups:
{% for group in oidc_allowed_groups | default(['admin', 'landl-users']) %}
    - "{{ group }}"
{% endfor %}

  pkce:
    enabled: true
    method: S256

  strip_email_domain: true
  allowed_domains:
    - "{{ domain }}"
    - "lotusandluna.com"

  expiry: 180d
  use_expiry_from_token: false
{% endif %}

# ACL Policy
policy:
  path: /etc/headscale/acl.yaml
