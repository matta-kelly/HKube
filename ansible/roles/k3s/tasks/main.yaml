# ==============================================================================
# K3s Role - Install Kubernetes
# ==============================================================================
# Supports two modes via k3s_role variable:
#
# Server mode (k3s_role: server):
#   --flannel-backend=vxlan      (VXLAN overlay network)
#   --flannel-iface=tailscale0   (use Tailscale interface for VXLAN tunneling)
#   --flannel-external-ip        (advertise external IPs)
#   --disable=traefik            (we install traefik via flux)
#
# Agent mode (k3s_role: agent):
#   Joins existing cluster via K3S_URL and K3S_TOKEN
#
# For hybrid clusters, nodes use their Tailscale IP (--node-ip) so pod traffic
# routes through the Tailscale mesh network.
# ==============================================================================

---
- name: Validate k3s_role
  ansible.builtin.assert:
    that:
      - k3s_role is defined
      - k3s_role in ['server', 'agent']
    fail_msg: "k3s_role must be 'server' or 'agent'"

- name: Get Tailscale IP for hybrid cluster networking
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false

- name: Set facts from inventory or environment
  ansible.builtin.set_fact:
    node_hostname: "{{ tailscale_hostname | default(lookup('env', 'NODE_HOSTNAME')) }}"
    k3s_version: "{{ lookup('env', 'K3S_VERSION') | default('v1.31.3+k3s1', true) }}"
    tailscale_ip: "{{ tailscale_ip_result.stdout | trim }}"

# ------------------------------------------------------------------------------
# Node Labels - From inventory (config.yaml) or hardware detection
# ------------------------------------------------------------------------------

# Option 1: Use labels from inventory (preferred - from config.yaml)
- name: Build labels from inventory
  ansible.builtin.set_fact:
    node_labels: >-
      {% for key, value in k3s_labels.items() %}--node-label={{ key }}={{ value }} {% endfor %}
    labels_source: "inventory"
  when: k3s_labels is defined

# ------------------------------------------------------------------------------
# Hardware Detection (always runs for validation)
# ------------------------------------------------------------------------------
- name: Detect NVMe storage
  ansible.builtin.shell: lsblk -d -o NAME,TRAN 2>/dev/null | grep -q nvme
  register: has_nvme
  failed_when: false
  changed_when: false

- name: Detect bulk storage mount
  ansible.builtin.stat:
    path: /mnt/bulk-storage
  register: bulk_storage_mount

# Validate config matches hardware (warn on mismatch)
- name: Validate storage config matches hardware
  ansible.builtin.debug:
    msg: |
      WARNING: Storage config mismatch detected!
        Config says nvme={{ k3s_labels['storage.h-kube.io/nvme'] | default('not set') }}
        Hardware has nvme={{ 'true' if has_nvme.rc == 0 else 'false' }}

      Update config/config.yaml and re-run: make generate && make node-configure NODE={{ node_hostname }}
  when:
    - k3s_labels is defined
    - k3s_labels['storage.h-kube.io/nvme'] is defined
    - (k3s_labels['storage.h-kube.io/nvme'] | lower == 'true') != (has_nvme.rc == 0)

# Option 2: Fall back to hardware detection (local bootstrap without inventory)
- name: Build labels from hardware detection
  ansible.builtin.set_fact:
    node_labels: >-
      --node-label=node.h-kube.io/role={{ k3s_role }}
      {% if has_nvme.rc == 0 %}--node-label=storage.h-kube.io/nvme=true{% else %}--node-label=storage.h-kube.io/nvme=false{% endif %}
      {% if bulk_storage_mount.stat.exists | default(false) %}--node-label=storage.h-kube.io/bulk=true{% else %}--node-label=storage.h-kube.io/bulk=false{% endif %}
    labels_source: "hardware-detection"
  when: k3s_labels is not defined

- name: Display labels to apply
  ansible.builtin.debug:
    msg: |
      Labels source: {{ labels_source }}
      Labels to apply:
      {% if k3s_labels is defined %}
      {% for key, value in k3s_labels.items() %}  - {{ key }}={{ value }}
      {% endfor %}
      {% else %}
        - node.h-kube.io/role={{ k3s_role }}
        {% if has_nvme.rc == 0 %}- storage.h-kube.io/nvme=true{% endif %}
        {% if bulk_storage_mount.stat.exists | default(false) %}- storage.h-kube.io/bulk=true{% endif %}
      {% endif %}

- name: Set agent facts from environment
  ansible.builtin.set_fact:
    k3s_url: "{{ lookup('env', 'K3S_URL') }}"
    k3s_token: "{{ lookup('env', 'K3S_TOKEN') }}"
  when: k3s_role == 'agent'

- name: Validate agent requirements
  ansible.builtin.assert:
    that:
      - k3s_url | length > 0
      - k3s_token | length > 0
    fail_msg: "K3S_URL and K3S_TOKEN environment variables are required for agent mode"
  when: k3s_role == 'agent'

- name: Check if k3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

# ------------------------------------------------------------------------------
# Install k3s
# ------------------------------------------------------------------------------
- name: Download k3s install script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: "0755"
  when: not k3s_binary.stat.exists

- name: Install k3s server
  ansible.builtin.command:
    cmd: /tmp/k3s-install.sh
  environment:
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
    INSTALL_K3S_EXEC: >-
      server
      --node-ip={{ tailscale_ip }}
      --flannel-backend=vxlan
      --flannel-iface=tailscale0
      --flannel-external-ip
      --disable=traefik
      --tls-san=api.{{ kube_domain }}
      --tls-san={{ tailscale_ip }}
      {{ node_labels }}
  when:
    - k3s_role == 'server'
    - not k3s_binary.stat.exists
  changed_when: true

- name: Install k3s agent
  ansible.builtin.command:
    cmd: /tmp/k3s-install.sh
  environment:
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
    INSTALL_K3S_EXEC: "agent --node-ip={{ tailscale_ip }} --flannel-iface=tailscale0 {{ node_labels }}"
    K3S_URL: "{{ k3s_url }}"
    K3S_TOKEN: "{{ k3s_token }}"
  when:
    - k3s_role == 'agent'
    - not k3s_binary.stat.exists
  changed_when: true

# ------------------------------------------------------------------------------
# Reconfigure existing k3s (updates systemd service if config changed)
# ------------------------------------------------------------------------------
- name: Update k3s server service config
  ansible.builtin.template:
    src: k3s-server.service.j2
    dest: /etc/systemd/system/k3s.service
    mode: "0644"
  when:
    - k3s_role == 'server'
    - k3s_binary.stat.exists
  notify: Restart k3s server

- name: Update k3s agent service config
  ansible.builtin.template:
    src: k3s-agent.service.j2
    dest: /etc/systemd/system/k3s-agent.service
    mode: "0644"
  when:
    - k3s_role == 'agent'
    - k3s_binary.stat.exists
  notify: Restart k3s agent

- name: Wait for k3s to start
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 60
  when: k3s_role == 'server'

- name: Wait for k3s agent to start
  ansible.builtin.wait_for:
    path: /var/lib/rancher/k3s/agent/kubelet.kubeconfig
    state: present
    timeout: 60
  when: k3s_role == 'agent'

# ------------------------------------------------------------------------------
# Health Checks
# ------------------------------------------------------------------------------
- name: Verify k3s server is healthy
  ansible.builtin.command: kubectl get nodes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: k3s_health
  retries: 5
  delay: 10
  until: k3s_health.rc == 0
  when: k3s_role == 'server'
  changed_when: false

- name: Verify agent registered with cluster
  ansible.builtin.command: k3s kubectl get nodes
  register: agent_health
  retries: 6
  delay: 10
  until: agent_health.rc == 0 and node_hostname in agent_health.stdout
  when: k3s_role == 'agent'
  changed_when: false
  failed_when: false

- name: Agent health check result
  ansible.builtin.debug:
    msg: "{{ 'Node registered successfully' if (agent_health.rc == 0 and node_hostname in agent_health.stdout) else 'WARNING: Node may not be registered yet. Check with: kubectl get nodes' }}"
  when: k3s_role == 'agent'

# ------------------------------------------------------------------------------
# Display K3s token (server only)
# ------------------------------------------------------------------------------
- name: Read K3s token
  ansible.builtin.slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_token_file
  when: k3s_role == 'server'

- name: Display K3s token
  ansible.builtin.debug:
    msg: |

      =============================================
      SAVE THIS TO config/secrets.env:

      K3S_TOKEN="{{ k3s_token_file.content | b64decode | trim }}"
      =============================================
  when: k3s_role == 'server'

# ------------------------------------------------------------------------------
# Configure kubeconfig on server
# ------------------------------------------------------------------------------
- name: Ensure .kube directory exists
  ansible.builtin.file:
    path: "/home/{{ admin_user }}/.kube"
    state: directory
    mode: "0755"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
  when: k3s_role == 'server'

- name: Copy kubeconfig to user directory
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ admin_user }}/.kube/config"
    remote_src: true
    mode: "0600"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
  when: k3s_role == 'server'

- name: Set KUBECONFIG in bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ admin_user }}/.bashrc"
    line: "export KUBECONFIG=$HOME/.kube/config"
    create: true
    mode: "0644"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
  when: k3s_role == 'server'

# ------------------------------------------------------------------------------
# Fetch kubeconfig to local machine (server only)
# ------------------------------------------------------------------------------
- name: Fetch kubeconfig to control node
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ playbook_dir }}/../kubeconfig.yaml"
    flat: true
  run_once: true
  when: k3s_role == 'server'

- name: Update kubeconfig server address
  ansible.builtin.replace:
    path: "{{ playbook_dir }}/../kubeconfig.yaml"
    regexp: "127\\.0\\.0\\.1"
    replace: "api.{{ kube_domain }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: k3s_role == 'server'

# ------------------------------------------------------------------------------
# Apply labels to existing nodes (idempotent)
# ------------------------------------------------------------------------------
- name: Apply labels from inventory to node (server)
  ansible.builtin.shell: |
    {% for key, value in k3s_labels.items() %}
    kubectl label node {{ node_hostname }} {{ key }}={{ value }} --overwrite
    {% endfor %}
  when:
    - k3s_role == 'server'
    - k3s_labels is defined
  changed_when: true

- name: Apply labels from hardware detection to node (server)
  ansible.builtin.shell: |
    kubectl label node {{ node_hostname }} node.h-kube.io/role={{ k3s_role }} --overwrite
    {% if has_nvme.rc == 0 %}
    kubectl label node {{ node_hostname }} storage.h-kube.io/nvme=true --overwrite
    {% endif %}
    {% if bulk_storage_mount.stat.exists | default(false) %}
    kubectl label node {{ node_hostname }} storage.h-kube.io/bulk=true --overwrite
    {% endif %}
  when:
    - k3s_role == 'server'
    - k3s_labels is not defined
  changed_when: true

# ------------------------------------------------------------------------------
# Agent success message
# ------------------------------------------------------------------------------
- name: Display agent success message
  ansible.builtin.debug:
    msg: |

      =============================================
      K3s agent installed successfully!
      Node {{ node_hostname }} is joining the cluster.

      Labels source: {{ labels_source }}
      Labels applied:
      {% if k3s_labels is defined %}
      {% for key, value in k3s_labels.items() %}  - {{ key }}={{ value }}
      {% endfor %}
      {% else %}
        - node.h-kube.io/role=agent
        {% if has_nvme.rc == 0 %}- storage.h-kube.io/nvme=true{% endif %}
        {% if bulk_storage_mount.stat.exists | default(false) %}- storage.h-kube.io/bulk=true{% endif %}
      {% endif %}

      Check status with: kubectl get nodes --show-labels
      =============================================
  when: k3s_role == 'agent'
