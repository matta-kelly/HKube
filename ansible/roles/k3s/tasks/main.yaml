# ==============================================================================
# K3s Role - Install Kubernetes
# ==============================================================================
# Supports two modes via k3s_role variable:
#
# Server mode (k3s_role: server):
#   --flannel-backend=vxlan      (VXLAN overlay network)
#   --flannel-iface=tailscale0   (use Tailscale interface for VXLAN tunneling)
#   --flannel-external-ip        (advertise external IPs)
#   --disable=traefik            (we install traefik via flux)
#
# Agent mode (k3s_role: agent):
#   Joins existing cluster via K3S_URL and K3S_TOKEN
#
# For hybrid clusters, nodes use their Tailscale IP (--node-ip) so pod traffic
# routes through the Tailscale mesh network.
# ==============================================================================

---
- name: Validate k3s_role
  ansible.builtin.assert:
    that:
      - k3s_role is defined
      - k3s_role in ['server', 'agent']
    fail_msg: "k3s_role must be 'server' or 'agent'"

- name: Get Tailscale IP for hybrid cluster networking
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false

- name: Set facts from inventory or environment
  ansible.builtin.set_fact:
    node_hostname: "{{ tailscale_hostname | default(lookup('env', 'NODE_HOSTNAME')) }}"
    k3s_version: "{{ lookup('env', 'K3S_VERSION') | default('v1.31.3+k3s1', true) }}"
    tailscale_ip: "{{ tailscale_ip_result.stdout | trim }}"

- name: Set agent facts from environment
  ansible.builtin.set_fact:
    k3s_url: "{{ lookup('env', 'K3S_URL') }}"
    k3s_token: "{{ lookup('env', 'K3S_TOKEN') }}"
  when: k3s_role == 'agent'

- name: Validate agent requirements
  ansible.builtin.assert:
    that:
      - k3s_url | length > 0
      - k3s_token | length > 0
    fail_msg: "K3S_URL and K3S_TOKEN environment variables are required for agent mode"
  when: k3s_role == 'agent'

- name: Check if k3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

# ------------------------------------------------------------------------------
# Install k3s
# ------------------------------------------------------------------------------
- name: Download k3s install script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: "0755"
  when: not k3s_binary.stat.exists

- name: Install k3s server
  ansible.builtin.command:
    cmd: /tmp/k3s-install.sh
  environment:
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
    INSTALL_K3S_EXEC: >-
      server
      --node-ip={{ tailscale_ip }}
      --flannel-backend=vxlan
      --flannel-iface=tailscale0
      --flannel-external-ip
      --disable=traefik
      --tls-san=api.{{ kube_domain }}
      --tls-san={{ tailscale_ip }}
  when:
    - k3s_role == 'server'
    - not k3s_binary.stat.exists
  changed_when: true

- name: Install k3s agent
  ansible.builtin.command:
    cmd: /tmp/k3s-install.sh
  environment:
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
    INSTALL_K3S_EXEC: "agent --node-ip={{ tailscale_ip }} --flannel-iface=tailscale0"
    K3S_URL: "{{ k3s_url }}"
    K3S_TOKEN: "{{ k3s_token }}"
  when:
    - k3s_role == 'agent'
    - not k3s_binary.stat.exists
  changed_when: true

# ------------------------------------------------------------------------------
# Reconfigure existing k3s (updates systemd service if config changed)
# ------------------------------------------------------------------------------
- name: Update k3s server service config
  ansible.builtin.template:
    src: k3s-server.service.j2
    dest: /etc/systemd/system/k3s.service
    mode: "0644"
  when:
    - k3s_role == 'server'
    - k3s_binary.stat.exists
  notify: Restart k3s server

- name: Update k3s agent service config
  ansible.builtin.template:
    src: k3s-agent.service.j2
    dest: /etc/systemd/system/k3s-agent.service
    mode: "0644"
  when:
    - k3s_role == 'agent'
    - k3s_binary.stat.exists
  notify: Restart k3s agent

- name: Wait for k3s to start
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 60
  when: k3s_role == 'server'

- name: Wait for k3s agent to start
  ansible.builtin.wait_for:
    path: /var/lib/rancher/k3s/agent/kubelet.kubeconfig
    state: present
    timeout: 60
  when: k3s_role == 'agent'

# ------------------------------------------------------------------------------
# Display K3s token (server only)
# ------------------------------------------------------------------------------
- name: Read K3s token
  ansible.builtin.slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_token_file
  when: k3s_role == 'server'

- name: Display K3s token
  ansible.builtin.debug:
    msg: |

      =============================================
      SAVE THIS TO .env:

      K3S_TOKEN="{{ k3s_token_file.content | b64decode | trim }}"
      =============================================
  when: k3s_role == 'server'

# ------------------------------------------------------------------------------
# Configure kubeconfig on server
# ------------------------------------------------------------------------------
- name: Ensure .kube directory exists
  ansible.builtin.file:
    path: "/home/{{ admin_user }}/.kube"
    state: directory
    mode: "0755"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
  when: k3s_role == 'server'

- name: Copy kubeconfig to user directory
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ admin_user }}/.kube/config"
    remote_src: true
    mode: "0600"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
  when: k3s_role == 'server'

- name: Set KUBECONFIG in bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ admin_user }}/.bashrc"
    line: "export KUBECONFIG=$HOME/.kube/config"
    create: true
    mode: "0644"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
  when: k3s_role == 'server'

# ------------------------------------------------------------------------------
# Fetch kubeconfig to local machine (server only)
# ------------------------------------------------------------------------------
- name: Fetch kubeconfig to control node
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ playbook_dir }}/../kubeconfig.yaml"
    flat: true
  run_once: true
  when: k3s_role == 'server'

- name: Update kubeconfig server address
  ansible.builtin.replace:
    path: "{{ playbook_dir }}/../kubeconfig.yaml"
    regexp: "127\\.0\\.0\\.1"
    replace: "api.{{ kube_domain }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: k3s_role == 'server'

# ------------------------------------------------------------------------------
# Agent success message
# ------------------------------------------------------------------------------
- name: Display agent success message
  ansible.builtin.debug:
    msg: |

      =============================================
      K3s agent installed successfully!
      Node {{ node_hostname }} is joining the cluster.

      Check status with: kubectl get nodes
      =============================================
  when: k3s_role == 'agent'
