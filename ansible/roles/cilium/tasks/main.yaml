# ==============================================================================
# Cilium Role - Install CNI
# ==============================================================================
# Installs cilium as the container network interface (CNI)
# Replaces flannel and kube-proxy with eBPF-based networking
# ==============================================================================

---
# For hybrid clusters, Cilium needs to reach the API server from all nodes.
# We use the node's public IP (which is in the k3s TLS certificate SANs).
# The ansible_host variable contains the public IP from inventory.
- name: Set facts from environment
  ansible.builtin.set_fact:
    cilium_version: "{{ lookup('env', 'CILIUM_VERSION') | default('1.16.4', true) }}"
    k8s_api_host: "{{ ansible_host }}"

# ------------------------------------------------------------------------------
# Install Helm (required for cilium installation)
# ------------------------------------------------------------------------------
- name: Install Helm
  ansible.builtin.shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm

# ------------------------------------------------------------------------------
# Install Cilium via Helm
# ------------------------------------------------------------------------------
- name: Add Cilium Helm repo
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Template Cilium values
  ansible.builtin.template:
    src: values.yaml.j2
    dest: /tmp/cilium-values.yaml
    mode: "0644"

- name: Install Cilium
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: "{{ cilium_version }}"
    release_namespace: kube-system
    create_namespace: false
    values_files:
      - /tmp/cilium-values.yaml
    wait: true
    wait_timeout: 5m
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

# ------------------------------------------------------------------------------
# Verify installation
# ------------------------------------------------------------------------------
- name: Wait for Cilium pods
  ansible.builtin.command: kubectl wait --for=condition=Ready pods -l k8s-app=cilium -n kube-system --timeout=300s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Verify node is ready
  ansible.builtin.command: kubectl get nodes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: nodes_status
  until: "'Ready' in nodes_status.stdout"
  retries: 30
  delay: 10
  changed_when: false