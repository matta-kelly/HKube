# ==============================================================================
# Base Role - Server Hardening
# ==============================================================================
# Applied to ALL servers (Headscale VPS, home server, Hetzner workers)
#
# Variables (all optional):
#   admin_user: Username for admin (default: mkultra)
#   ssh_port: SSH port (default: 22)
#   ssh_public_key_file: Path to public key (skipped if not set)
#   firewall_allow_ports: List of {port, proto} to allow
# ==============================================================================

# ------------------------------------------------------------------------------
# System Updates (with idempotency)
# ------------------------------------------------------------------------------

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Check for available upgrades
  ansible.builtin.command: apt list --upgradable
  register: upgradable_packages
  changed_when: false

- name: Upgrade packages (only if upgrades available)
  ansible.builtin.apt:
    upgrade: dist
  when: upgradable_packages.stdout_lines | length > 1

# ------------------------------------------------------------------------------
# Install Security Packages
# ------------------------------------------------------------------------------

- name: Install security packages
  ansible.builtin.apt:
    name:
      - fail2ban
      - ufw
      - unattended-upgrades
      - apt-listchanges
      - auditd
      - audispd-plugins
    state: present

# ------------------------------------------------------------------------------
# Create Admin User (non-root)
# ------------------------------------------------------------------------------

- name: Create admin user
  ansible.builtin.user:
    name: "{{ admin_user | default('mkultra') }}"
    groups: sudo
    shell: /bin/bash
    create_home: true
    state: present

- name: Add SSH key to admin user (remote bootstrap)
  ansible.posix.authorized_key:
    user: "{{ admin_user | default('mkultra') }}"
    key: "{{ lookup('file', ssh_public_key_file) }}"
    state: present
  when: ssh_public_key_file is defined

- name: Allow admin user passwordless sudo
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ admin_user | default('mkultra') }}
    line: "{{ admin_user | default('mkultra') }} ALL=(ALL) NOPASSWD:ALL"
    create: true
    mode: "0440"
    validate: "visudo -cf %s"

# ------------------------------------------------------------------------------
# SSH Hardening
# ------------------------------------------------------------------------------

- name: Configure SSH hardening
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^#?Port ', line: 'Port {{ ssh_port | default(22) }}' }
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
    - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
    - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
    - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
    - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
    - { regexp: '^#?AllowAgentForwarding', line: 'AllowAgentForwarding no' }
    - { regexp: '^#?AllowTcpForwarding', line: 'AllowTcpForwarding no' }
  notify: Restart SSH

# ------------------------------------------------------------------------------
# Kernel Hardening
# ------------------------------------------------------------------------------

- name: Apply kernel hardening sysctl
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-security.conf
    reload: true
  loop:
    # Prevent IP spoofing
    - { key: "net.ipv4.conf.all.rp_filter", value: "1" }
    - { key: "net.ipv4.conf.default.rp_filter", value: "1" }
    # Ignore ICMP redirects
    - { key: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { key: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { key: "net.ipv6.conf.all.accept_redirects", value: "0" }
    - { key: "net.ipv6.conf.default.accept_redirects", value: "0" }
    # Don't send ICMP redirects
    - { key: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { key: "net.ipv4.conf.default.send_redirects", value: "0" }
    # Ignore broadcast pings
    - { key: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }
    # Protect against SYN flood
    - { key: "net.ipv4.tcp_syncookies", value: "1" }
    # Log martian packets
    - { key: "net.ipv4.conf.all.log_martians", value: "1" }

# ------------------------------------------------------------------------------
# Fail2Ban
# ------------------------------------------------------------------------------

- name: Configure fail2ban jail
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    mode: "0644"
    content: |
      # H-Kube fail2ban configuration
      [DEFAULT]
      bantime = 1h
      bantime.increment = true
      bantime.factor = 2
      bantime.maxtime = 5w
      findtime = 10m
      maxretry = 3
      backend = systemd
      banaction = ufw

      [sshd]
      enabled = true
      port = {{ ssh_port | default(22) }}
      filter = sshd
      maxretry = 3
  notify: Restart fail2ban

- name: Enable and start fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started

# ------------------------------------------------------------------------------
# Audit Logging
# ------------------------------------------------------------------------------

- name: Configure auditd rules
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/h-kube.rules
    mode: "0640"
    content: |
      # H-Kube audit rules
      # Log all commands run as root
      -a always,exit -F arch=b64 -F euid=0 -S execve -k root_commands
      # Log sudo usage
      -w /etc/sudoers -p wa -k sudoers
      -w /etc/sudoers.d/ -p wa -k sudoers
      # Log SSH config changes
      -w /etc/ssh/sshd_config -p wa -k sshd_config
      # Log user/group changes
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
  notify: Restart auditd

- name: Enable and start auditd
  ansible.builtin.systemd:
    name: auditd
    enabled: true
    state: started

# ------------------------------------------------------------------------------
# UFW Firewall
# ------------------------------------------------------------------------------

- name: Rate limit SSH connections
  community.general.ufw:
    rule: limit
    port: "{{ ssh_port | default(22) }}"
    proto: tcp

- name: Set UFW default deny incoming
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Set UFW default allow outgoing
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Allow additional ports through UFW
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  loop: "{{ firewall_allow_ports | default([]) }}"

- name: Enable UFW
  community.general.ufw:
    state: enabled

# ------------------------------------------------------------------------------
# Unattended Upgrades
# ------------------------------------------------------------------------------

- name: Configure unattended-upgrades
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    mode: "0644"
    content: |
      // H-Kube unattended-upgrades configuration
      Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}";
        "${distro_id}:${distro_codename}-security";
        "${distro_id}ESMApps:${distro_codename}-apps-security";
        "${distro_id}ESM:${distro_codename}-infra-security";
      };

      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";

- name: Enable automatic updates
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    mode: "0644"
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
