# ==============================================================================
# HAProxy Configuration - K3s API Load Balancer
# ==============================================================================
# Managed by Ansible - do not edit manually
# ==============================================================================

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

resolvers tailscale
    nameserver ts 100.100.100.100:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold valid      10s
    hold nx         5s

frontend k3s_api
    bind {{ tailscale_ip }}:6443
    default_backend k3s_control_planes

backend k3s_control_planes
    option tcp-check
    balance roundrobin
    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 resolvers tailscale init-addr none
{% for cp in control_planes %}
    server {{ cp }} {{ cp }}.{{ headscale_base_domain }}:6443 check
{% endfor %}
