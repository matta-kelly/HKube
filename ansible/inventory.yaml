# ==============================================================================
# H-Kube Ansible Inventory
# ==============================================================================
# All configuration comes from environment variables in .env
# ==============================================================================

all:
  vars:
    # --------------------------------------------------------------------------
    # Base role variables
    # --------------------------------------------------------------------------
    admin_user: "{{ lookup('env', 'HEADSCALE_USER') | default(lookup('env', 'SERVER_USER'), true) | default('mkultra', true) }}"
    ssh_public_key_file: "{{ lookup('env', 'SSH_PUBLIC_KEY_FILE') | default('~/.ssh/id_ed25519_hetzner.pub', true) }}"
    firewall_allow_ports: []

    # --------------------------------------------------------------------------
    # GitHub / Flux
    # --------------------------------------------------------------------------
    github_user: "{{ lookup('env', 'GITHUB_USER') }}"
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
    github_repo: "{{ lookup('env', 'GITHUB_REPO') | default('h-kube', true) }}"
    github_branch: "{{ lookup('env', 'GITHUB_BRANCH') | default('main', true) }}"

    # --------------------------------------------------------------------------
    # Version pins
    # --------------------------------------------------------------------------
    k3s_version: "v1.31.3+k3s1"
    cilium_version: "1.16.4"
    sops_version: "3.9.0"

  children:
    # --------------------------------------------------------------------------
    # Headscale VPS
    # --------------------------------------------------------------------------
    headscale:
      hosts:
        headscale-vps:
          ansible_host: "{{ lookup('env', 'HEADSCALE_IP') }}"
          ansible_user: root  # First run only, then use HEADSCALE_USER
          admin_user: "{{ lookup('env', 'HEADSCALE_USER') | default('mkultra', true) }}"
      vars:
        firewall_allow_ports:
          - { port: "80", proto: "tcp" }
          - { port: "443", proto: "tcp" }
          - { port: "3478", proto: "udp" }

    # --------------------------------------------------------------------------
    # Home Server (k3s)
    # --------------------------------------------------------------------------
    k3s_cluster:
      hosts:
        home-server:
          ansible_host: "{{ lookup('env', 'SERVER_IP') }}"
          ansible_user: "{{ lookup('env', 'SERVER_USER') | default('mkultra', true) }}"
          admin_user: "{{ lookup('env', 'SERVER_USER') | default('mkultra', true) }}"
      vars:
        server_ip: "{{ lookup('env', 'SERVER_IP') }}"
        firewall_allow_ports:
          - { port: "6443", proto: "tcp" }
          - { port: "80", proto: "tcp" }
          - { port: "443", proto: "tcp" }