# ==============================================================================
# Airbyte Helm Release (V2)
# ==============================================================================
# Data integration platform - ELT connectors
# Uses CNPG PostgreSQL, built-in Minio for internal storage
# ==============================================================================

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: airbyte
  namespace: airbyte
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: airbyte
      version: "2.x"
      sourceRef:
        kind: HelmRepository
        name: airbyte
        namespace: flux-system

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  dependsOn:
    - name: cloudnative-pg
      namespace: cnpg-system

  values:
    # -------------------------------------------------------------------------
    # Global settings
    # -------------------------------------------------------------------------
    global:
      database:
        type: external
        host: airbyte-db-rw.airbyte.svc.cluster.local
        port: 5432
        name: airbyte
        user: airbyte
        secretName: airbyte-db-app
        userSecretKey: username
        passwordSecretKey: password

      jobs:
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 4
            memory: 8Gi

    # -------------------------------------------------------------------------
    # Disable bundled dependencies (we use external CNPG + SeaweedFS)
    # Disable chart ingress (we manage our own ingress.yaml)
    # -------------------------------------------------------------------------
    postgresql:
      enabled: false

    minio:
      enabled: true
      nodeSelector:
        node.h-kube.io/location: home

    ingress:
      enabled: false

    # -------------------------------------------------------------------------
    # Server - API server, runs at home
    # -------------------------------------------------------------------------
    server:
      nodeSelector:
        node.h-kube.io/location: home
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values: ["monkeybusiness"]
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1
          memory: 2Gi

    # -------------------------------------------------------------------------
    # Worker - heavy lifting, prefers monkeybusiness (more RAM)
    # -------------------------------------------------------------------------
    worker:
      nodeSelector:
        node.h-kube.io/location: home
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values: ["monkeybusiness"]
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2
          memory: 4Gi

    # -------------------------------------------------------------------------
    # Workload launcher - prefers monkeybusiness (more RAM)
    # -------------------------------------------------------------------------
    workloadLauncher:
      nodeSelector:
        node.h-kube.io/location: home
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values: ["monkeybusiness"]
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1
          memory: 2Gi

    # -------------------------------------------------------------------------
    # Connector Builder Server - move off control plane
    # -------------------------------------------------------------------------
    connectorBuilderServer:
      nodeSelector:
        node.h-kube.io/location: home

    # -------------------------------------------------------------------------
    # Workload API Server - move off control plane
    # -------------------------------------------------------------------------
    workloadApiServer:
      nodeSelector:
        node.h-kube.io/location: home
