# ==============================================================================
# Vault Helm Release
# ==============================================================================
# HashiCorp Vault - Secrets management
# Single instance, manual unseal, PostgreSQL storage via CNPG
# ==============================================================================

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vault
  namespace: vault
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: vault
      version: "0.28.x"
      sourceRef:
        kind: HelmRepository
        name: hashicorp
        namespace: flux-system

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  dependsOn:
    - name: cloudnative-pg
      namespace: cnpg-system

  values:
    # -------------------------------------------------------------------------
    # Server configuration
    # -------------------------------------------------------------------------
    server:
      enabled: true

      # Single instance (no HA for now)
      standalone:
        enabled: true
        config: |
          ui = true

          listener "tcp" {
            tls_disable = 1
            address = "[::]:8200"
            cluster_address = "[::]:8201"
          }

          storage "postgresql" {
            connection_url = "postgres://vault@vault-db-rw.vault.svc.cluster.local:5432/vault?sslmode=disable"
          }

      # Run on home nodes
      nodeSelector:
        node.h-kube.io/location: home

      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values: ["monkeybusiness"]

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

      # Data storage for file-based audit logs etc
      dataStorage:
        enabled: true
        size: 1Gi
        storageClass: local-path

    # -------------------------------------------------------------------------
    # UI - enabled, ingress handled separately
    # -------------------------------------------------------------------------
    ui:
      enabled: true
      serviceType: ClusterIP

    # -------------------------------------------------------------------------
    # Injector - disabled for now (can enable later for sidecar injection)
    # -------------------------------------------------------------------------
    injector:
      enabled: false

    # -------------------------------------------------------------------------
    # CSI Provider - disabled for now
    # -------------------------------------------------------------------------
    csi:
      enabled: false
