# ==============================================================================
# Cube.js Deployment
# ==============================================================================
# Semantic layer exposing DuckLake data via PostgreSQL protocol and REST API
# ==============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cube
  namespace: lotus-lake
  labels:
    app: cube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cube
  template:
    metadata:
      labels:
        app: cube
    spec:
      nodeSelector:
        kubernetes.io/hostname: monkeybusiness
      containers:
        - name: cube
          image: ghcr.io/matta-kelly/lotus-lake-cube:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 4000
            - name: postgres
              containerPort: 5432
          env:
            # Cube.js DuckDB native S3 configuration
            - name: CUBEJS_DB_TYPE
              value: "duckdb"
            - name: CUBEJS_DB_DUCKDB_S3_ENDPOINT
              value: "seaweedfs-s3.seaweedfs.svc.cluster.local:8333"
            - name: CUBEJS_DB_DUCKDB_S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: minio_user
            - name: CUBEJS_DB_DUCKDB_S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: minio_password
            - name: CUBEJS_DB_DUCKDB_S3_USE_SSL
              value: "false"
            - name: CUBEJS_DB_DUCKDB_S3_URL_STYLE
              value: "path"
            # DuckLake catalog connection (used by cube.js driverFactory)
            - name: DUCKLAKE_DB_HOST
              value: "ducklake-db-rw.lotus-lake.svc.cluster.local"
            - name: DUCKLAKE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ducklake-db-app
                  key: password
            # Cube.js API secret
            - name: CUBEJS_API_SECRET
              valueFrom:
                secretKeyRef:
                  name: lotus-lake-terraform-vars
                  key: minio_password
          resources:
            requests:
              memory: "2Gi"
              cpu: "500m"
            limits:
              memory: "8Gi"
              cpu: "2"
          readinessProbe:
            httpGet:
              path: /readyz
              port: 4000
            initialDelaySeconds: 60
            periodSeconds: 10
            failureThreshold: 10
          livenessProbe:
            httpGet:
              path: /livez
              port: 4000
            initialDelaySeconds: 120
            periodSeconds: 30
            failureThreshold: 5
---
apiVersion: v1
kind: Service
metadata:
  name: cube
  namespace: lotus-lake
  labels:
    app: cube
spec:
  selector:
    app: cube
  ports:
    - name: http
      port: 4000
      targetPort: 4000
    - name: postgres
      port: 5432
      targetPort: 5432
