# H-Kube

Hybrid Kubernetes infrastructure with Headscale mesh networking.

---

## What's Built

**Headscale VPS (Hetzner)**
- Mesh networking control plane
- Nodes connect from anywhere via Tailscale
- Let's Encrypt HTTPS auto-configured

**Base security hardening**
- Admin user with SSH key auth
- Root login disabled
- fail2ban, ufw, unattended-upgrades

---

## Prerequisites

**Local machine**
- Python 3 + pip
- Terraform: [install guide](https://developer.hashicorp.com/terraform/downloads)
- Tailscale: [install guide](https://tailscale.com/download)

**Hetzner Cloud**
- Account at [console.hetzner.cloud](https://console.hetzner.cloud)
- API token with read/write access

**Domain**
- A record pointing to Headscale VPS IP

---

## Quick Start
```bash
# 1. Clone and setup
git clone git@github.com:matta-kelly/HKube.git
cd HKube
make setup

# 2. Edit .env with your values

# 3. Create Headscale VPS
make headscale
# → Save HEADSCALE_IP to .env
# → Update DNS A record

# 4. Configure VPS
make headscale-init
# → Save HEADSCALE_AUTHKEY to .env

# 5. Connect your laptop
sudo tailscale up --login-server https://your.domain.com --authkey <KEY>

# 6. Verify
tailscale status
```

---

## Commands
```bash
make help                 # Show all commands

# Setup
make setup                # Create .env from template

# Headscale VPS
make headscale            # Create VPS (Terraform)
make headscale-init       # First-time config (as root)
make headscale-configure  # Re-configure (as admin user)
make headscale-ssh        # SSH into VPS
make headscale-destroy    # Destroy VPS
```

---

## Environment Variables

Create `.env` from `.env.example`:
```bash
# Hetzner Cloud
HCLOUD_TOKEN=""                    # From Hetzner console

# SSH
SSH_PUBLIC_KEY_FILE=""             # Path to your public key

# Headscale VPS
HEADSCALE_USER=""                  # Admin username you choose
HEADSCALE_DOMAIN=""                # e.g. headscale.yourdomain.com
HEADSCALE_BASE_DOMAIN=""           # e.g. mesh.yourdomain.com
HEADSCALE_IP=""                    # Set after 'make headscale'
HEADSCALE_AUTHKEY=""               # Set after 'make headscale-init'

# GitHub (for future Flux GitOps)
GITHUB_USER=""
GITHUB_TOKEN=""
GITHUB_REPO="h-kube"
GITHUB_BRANCH="main"
```

---

## Structure
```
h-kube/
├── .env                           # Your config (gitignored)
├── .env.example                   # Template
├── .gitignore
├── Makefile
├── README.md
├── ansible/
│   ├── ansible.cfg
│   ├── inventory.yml              # Generated by script
│   ├── headscale.yaml             # Headscale playbook
│   └── roles/
│       ├── base/                  # Security hardening
│       │   ├── tasks/main.yaml
│       │   └── handlers/main.yaml
│       └── headscale/             # Headscale install
│           ├── tasks/main.yaml
│           ├── handlers/main.yaml
│           └── templates/config.yaml.j2
├── scripts/
│   └── generate-inventory.sh      # Builds inventory from .env + Terraform
└── terraform/
    └── headscale-vps/
        ├── main.tf
        ├── variables.tf
        └── outputs.tf
```

---

## Adding Devices to Mesh

**Laptop/Desktop:**
```bash
sudo tailscale up --login-server https://headscale.yourdomain.com --authkey <KEY>
```

**Phone (iOS/Android):**
1. Install Tailscale app
2. Settings → Use custom coordination server
3. Enter: `https://headscale.yourdomain.com`
4. On your laptop, register the device:
```bash
ssh headscale
sudo headscale nodes register --user h-kube --key nodekey:xxxxx
```

**Verify all nodes:**
```bash
ssh headscale
sudo headscale nodes list
```

---

## Next Steps

- [ ] Connect home server to mesh
- [ ] Bootstrap K3s cluster
- [ ] Install Cilium CNI
- [ ] Deploy Flux GitOps
- [ ] Add apps (Vaultwarden, Immich, etc.)

---

## Disaster Recovery
```bash
# Headscale VPS gone? Rebuild from scratch:
make headscale
# Update DNS
make headscale-init
# Reconnect all devices with new authkey
```

All infrastructure is code. Nothing to backup except `.env` values (keep in password manager).